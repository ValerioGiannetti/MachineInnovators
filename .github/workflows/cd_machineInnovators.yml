name: Continuous Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install evaluate scikit-learn  # Assicurati che siano incluse

      # --- GATE DI CONTROLLO QUALITÀ ---
      - name: Evaluate Model Performance
        id: eval_step
        run: |
          python app/evaluate_model.py > evaluation_results.txt
          # Estraiamo l'accuracy dal log dello script (che stampa "Accuracy: 0.7218")
          ACCURACY=$(grep "Accuracy:" evaluation_results.txt | awk '{print $2}')
          echo "Accuracy rilevata: $ACCURACY"
          
          # Definito soglia minima
          THRESHOLD=${{ vars.MODEL_ACCURACY_THRESHOLD || 0.70 }}
          
          # Confronto
          if (( $(echo "$ACCURACY < $THRESHOLD" | bc -l) )); then
            echo "ERRORE: L'accuracy ($ACCURACY) è inferiore alla soglia ($THRESHOLD). Deploy annullato!"
            exit 1
          fi
          echo "VALIDAZIONE SUPERATA: Procedo al deploy."

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/machine-innovators-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/machine-innovators-api:${{ github.sha }}

      - name: Deploy Notification
        run: echo "Immagine validata e caricata con successo!"